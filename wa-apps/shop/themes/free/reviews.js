var reviewsImageBox=function(d){return(reviewsImageBox=function(e){var r=this;r.$wrapper=e.$wrapper,r.$file_field=r.$wrapper.find(".js-file-field"),r.$files_wrapper=r.$wrapper.find(".js-attached-files-box"),r.$errors_wrapper=r.$wrapper.find(".js-errors-box"),r.max_post_size=e.max_post_size,r.max_file_size=e.max_file_size,r.max_files=e.max_files,r.templates=e.templates,r.patterns=e.patterns,r.locales=e.locales,r.post_size=0,r.id_counter=0,r.files_data={},r.images_count=0,r.init()}).prototype.init=function(){var i=this,a=d(document);i.$wrapper.data("controller",i),i.$file_field.on("change",function(){l(this.files),i.$file_field.val("")}),i.$wrapper.on("click",".js-show-textarea",function(e){e.preventDefault(),d(this).closest(".review-desc-wrap").addClass("is-extended")}),i.$wrapper.on("click",".js-delete-file",function(e){e.preventDefault();var r=d(this).closest(".input-file-wrap"),t=""+r.data("file-id");t&&i.files_data[t]&&(e=i.files_data[t],i.post_size-=e.file.size,delete i.files_data[t],--i.images_count),r.remove(),i.renderErrors()}),i.$wrapper.on("keyup change",".js-textarea",function(e){var r=d(this),t=""+r.closest(".input-file-wrap").data("file-id");t&&i.files_data[t]&&(i.files_data[t].desc=r.val())});var r=null,t=!1;function n(e){e.preventDefault(),l(e.originalEvent.dataTransfer.files),o(!1)}function s(e){e.preventDefault(),r?clearTimeout(r):t||o(t=!0),r=setTimeout(function(){r=null,o(t=!1)},100)}function o(e){var r="is-box-hlighted";e?i.$wrapper.addClass(r):i.$wrapper.removeClass(r)}function l(e){var t=[],a=[];d.each(e,function(e,r){r=i.addFile(r);r.error&&(r=r.error,t.indexOf(r.type)<0&&(t.push(r.type),a.push(r)))}),i.renderErrors(a)}a.on("dragover",function e(r){var t=d.contains(document,i.$wrapper[0]);t?s(r):a.off("dragover",e)}),a.on("drop",function e(r){var t=d.contains(document,i.$wrapper[0]);t?n(r):a.off("drop",e)}),a.on("reset clear",function e(r){var t=d.contains(document,i.$wrapper[0]);t?i.reset():a.off("reset clear",e)})},reviewsImageBox.prototype.addFile=function(t){var e,r,a=this,i=t.size;if(t.type.match(/^image\/(png|jpe?g|gif)$/)){if(a.images_count>=a.max_files)return{error:{text:a.locales.files_limit,type:"files_limit"}};if(i>=a.max_file_size)return{error:{text:a.locales.file_size,type:"file_size"}};if(a.post_size+i>=a.max_file_size)return{error:{text:a.locales.post_size,type:"post_size"}};a.post_size+=i;var n=a.id_counter,i={id:n,file:t,desc:""};return a.files_data[n]=i,a.id_counter++,a.images_count+=1,e=d(a.templates.file),r=e.find(".review_image-wrap"),e.attr("data-file-id",n),function(){var r=d.Deferred(),e=new FileReader;return e.onload=function(e){r.resolve(e.target.result)},e.readAsDataURL(t),r.promise()}().then(function(e){r.css("background-image","url("+e+")")}),a.$files_wrapper.append(e),i}return{error:{text:a.locales.file_type,type:"file_type"}}},reviewsImageBox.prototype.reset=function(){var e=this;e.post_size=0,e.id_counter=0,e.files_data={},e.$files_wrapper.html(""),e.$errors_wrapper.html("")},reviewsImageBox.prototype.getSerializedArray=function(){var i=this,n=[],s=0;return d.each(i.files_data,function(e,r){var t=i.patterns.file.replace("%index%",s),a=i.patterns.desc.replace("%index%",s);n.push({name:t,value:r.file}),n.push({name:a,value:r.desc}),s++}),n},reviewsImageBox.prototype.renderErrors=function(e){var t=this,a=[];return t.$errors_wrapper.html(""),e&&e.length&&d.each(e,function(e,r){r.text&&((r=d(t.templates.error.replace("%text%",r.text))).appendTo(t.$errors_wrapper),a.push(r))}),a},reviewsImageBox}(jQuery);$(function(){var e={"alt+enter":{ctrl:!1,alt:!0,shift:!1,key:13},"ctrl+enter":{ctrl:!0,alt:!1,shift:!1,key:13},"ctrl+s":{ctrl:!0,alt:!1,shift:!1,key:17}},n=$("#product-add-review-form"),a=n.find("form"),s=$(".js-reviews"),o=a.find(".js-submit-button"),r=a.find("input[name=rate]");r.length||(r=$('<input name="rate" type="hidden" value=0>').appendTo(a)),$("#review-rate").rateWidget({onUpdate:function(e){r.val(e)}}),s.off("click",".review-reply, .review-write a").on("click",".review-reply, .review-write a",function(){var e=$(this),r=e.parents("li:first"),t=parseInt(r.attr("data-id"),10)||0;return function(e){e?(this.parents(".actions:first").after(n),$(".rate ",a).trigger("clear").parents(".add-review-field:first").hide()):(this.parents(".review-write").after(n),a.find(".rate").parents(".add-review-field:first").show());u(a,!1),$("input[name=parent_id]",a).val(e),n.show()}.call(e,t),$(".review").removeClass("in-reply-to"),r.find(".review:first").addClass("in-reply-to"),!1});var t,i,l,d=$(".wa-captcha"),p=$("#user-auth-provider li"),f=p.filter(".selected").attr("data-provider");"guest"!=f&&f?d.hide():d.show(),p.find("a").click(function(){var e=$(this).parents("li:first");if(e.hasClass("selected"))return!1;e.siblings(".selected").removeClass("selected"),e.addClass("selected");var r=e.attr("data-provider");if(a.find("input[name=auth_provider]").val(r),"guest"==r)return $("div.provider-input").hide(),$("div.provider-input[data-provider=guest]").show(),d.show(),!1;if(r==f)return $("div.provider-input").hide(),$("div.provider-input[data-provider="+r+"]").show(),d.hide(),!1;e=(screen.width-600)/2,r=(screen.height-400)/2;return window.open($(this).attr("href"),"oauth","width=600,height=400,left="+e+",top="+r+",status=no,toolbar=no,menubar=no"),!1}),t="textarea",i=function(e){a.trigger("submit")},l=e["ctrl+enter"],a.off("keydown",t).on("keydown",t,function(e){if(e.keyCode==l.key&&e.altKey==l.alt&&e.ctrlKey==l.ctrl&&e.shiftKey==l.shift)return i()});var c=!1;function u(e,r){r=void 0===r||r,$(".errormsg",e).remove(),$(".error",e).removeClass("error"),$(".wa-captcha-refresh",e).click(),"undefined"!=typeof grecaptcha&&grecaptcha.reset(),r&&($("input[name=captcha], textarea",e).val(""),$("input[name=rate]",e).val(0),$("input[name=title]",e).val(""),$(".rate",e).trigger("clear"))}a.on("submit",function(e){var r,i,t;e.preventDefault(),c||(c=!0,(r=a.find(".review-add-form-status")).show(),o.attr("disabled",!0).val(o.data("active")),t=(i=a).attr("action").replace(/(\/(#)\/[^#]*|\/#|\/$)|((\/\?|\?).*)/g,"")+"/add/",e=function(e){var r=e.serializeArray(),t=new FormData;$.each(r,function(){var e=$(this)[0];t.append(e.name,e.value)});e=e.find("#jreview-images-box");e.length&&(e=e.data("controller").getSerializedArray(),$.each(e,function(e,r){t.append(r.name,r.value)}));return t}(i),$.ajax({url:t,data:e,cache:!1,contentType:!1,processData:!1,type:"POST",success:function(e){if("fail"===e.status)return u(i,!1),void function(e,r){for(var t in r){var a=$("[name="+t+"]",e);("service_agreement"==t?a.closest(".js-review-agreement").append($('<em class="errormsg"></em>').text(r[t])):a.after($('<em class="errormsg"></em>').text(r[t]))).addClass("error")}}(i,e.errors);if("ok"!==e.status||!e.data.html)return void(console&&console.error("Error occured."));var r=e.data.html,t=parseInt(e.data.parent_id,10)||0,a=t?i.parents("li:first"):s,a=$("ul.reviews-list:first",a);t?(a.show().append(r),a.find("li:last .review").addClass("new")):(a.show().prepend(r),a.find("li:first .review").addClass("new"));$(".reviews-total").text(e.data.review_count_str),$(".reviews-count").text(e.data.count),i.find("input[name=count]").val(e.data.count),u(i,!0),s.find(".review-write a").click(),n.hide(),"function"==typeof success&&success(e)},error:function(e,r){console&&console.error("Error",r)}}).always(function(){c=!1,r.hide(),o.removeAttr("disabled").val(o.data("inactive"))}))})});